<script>// Replace the existing convertToTracklist function and event listeners with this code:

    document.addEventListener('DOMContentLoaded', function() {
        // Get all necessary elements
        const modal = document.getElementById('utilsModal');
        const modalBtn = document.getElementById('utilsModalBtn');
        const closeBtn = document.querySelector('.close');
        const cueFile = document.getElementById('cueFile');
        const cueText = document.getElementById('cueText');
        const output = document.getElementById('output');
        const convertBtn = document.querySelector('button');
        const formatSelect = document.getElementById('formatType');
    
        // File input handler
        cueFile.addEventListener('change', function(e) {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    cueText.value = e.target.result;
                };
                reader.readAsText(file);
            }
        });
    
        // Convert button handler
        convertBtn.addEventListener('click', function() {
            const content = cueText.value.trim();
            if (content) {
                processCueContent(content, formatSelect.value);
            } else {
                output.value = 'Please select a .cue file or paste content first';
            }
        });
    
        // Modal handlers
        modalBtn.onclick = function() {
            modal.style.display = "block";
            // Clear previous content
            cueText.value = '';
            output.value = '';
        }
    
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }
    
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    });
    
    function processCueContent(content, formatOption) {
        const lines = content.split("\n");
        let result = [];
        let seenTracks = new Set(); // Set to keep track of already added tracks
        let currentTimestamp = "";
        let currentTitle = "";
        let currentPerformer = "";
    
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
    
            if (line.startsWith("TITLE") && !line.startsWith("REM")) {
                const parts = line.split('"');
                if (parts.length > 1) {
                    currentTitle = parts[1];
                }
            } else if (line.startsWith("PERFORMER")) {
                const parts = line.split('"');
                if (parts.length > 1) {
                    currentPerformer = parts[1];
                }
            } else if (line.startsWith("INDEX 01")) {
                const timeParts = line.split(" ")[2].split(":");
                const minutes = parseInt(timeParts[0], 10);
                const seconds = parseInt(timeParts[1], 10);
                const frames = parseInt(timeParts[2], 10);
                const totalSeconds = minutes * 60 + seconds + frames / 75;
                currentTimestamp = formatTime(totalSeconds);
    
                if (currentPerformer && currentTitle) {
                    const trackKey = `${currentPerformer} - ${currentTitle}`;
                    
                    // Only add if this track hasn't been seen before
                    if (!seenTracks.has(trackKey)) {
                        if (formatOption === "timestamps") {
                            result.push(`${currentTimestamp} ${trackKey}`);
                        } else if (formatOption === "numbered") {
                            result.push(`${result.length + 1}. ${trackKey}`);
                            seenTracks.add(trackKey);
                        }
                        
                    }
                }
    
                currentTitle = "";
                currentPerformer = "";
            }
        }
    
        document.getElementById('output').value = result.join("\n");
    }
    
    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = Math.floor(totalSeconds % 60);
        return `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}:00`;
    }</script>